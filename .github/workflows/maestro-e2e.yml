name: E2E ‚Äì generate, run tests, build report

on:
  workflow_dispatch: {}
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  e2e:
    name: Run Maestro E2E on macOS
    runs-on: macos-15

    steps:
      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Cache dependencies (npm, Pods, Xcode derived data, built app)
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
            example/node_modules
            example/ios/Pods
            ~/Library/Developer/Xcode/DerivedData
            ~/Library/Caches/CocoaPods
          key: ${{ runner.os }}-expo-build-${{ hashFiles('example/ios/Podfile.lock', 'ios/**', 'ios-files/**') }}
          restore-keys: |
            ${{ runner.os }}-expo-

      # Restore cached built app (if exists)
      - name: Restore cached .app build
        id: app-cache
        uses: actions/cache@v4
        with:
          path: example/ios/build/Release-iphonesimulator
          key: ${{ runner.os }}-expo-app-${{ hashFiles('example/ios/Podfile.lock', 'ios/**', 'ios-files/**') }}

      # Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # Set up Java (Zulu 17)
      - name: Set up Java (Zulu 17)
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      # Install dependencies (root)
      - name: Install root dependencies
        run: npm ci

      # Generate Maestro test flows
      - name: Generate test flows
        env:
          MAESTRO_APP_ID: com.swmansion.expoliveactivity.example
        run: npm run generateTests

      # Start iOS simulator
      - name: Start iOS Simulator
        uses: futureware-tech/simulator-action@v2
        with:
          model: 'iPhone 16 Pro'

      # Install Maestro CLI (cached)
      - name: Install Maestro CLI (cached)
        uses: actions/cache@v4
        id: maestro-cache
        with:
          path: ~/.maestro/bin
          key: ${{ runner.os }}-maestro-${{ hashFiles('example/package-lock.json') }}

      - name: Install Maestro CLI (download if missing)
        if: steps.maestro-cache.outputs.cache-hit != 'true'
        run: |
          echo "Downloading Maestro CLI..."
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Verify Maestro CLI
        run: |
          export PATH="$PATH:$HOME/.maestro/bin"
          maestro --version

      # Wait for simulator to boot
      - name: Wait for iOS simulator
        run: sleep 20

      # Build and install the example app (Release, skip prebuild if no native changes)
      - name: Build and install example app
        if: steps.app-cache.outputs.cache-hit != 'true'
        env:
          EXPO_NO_DEV_SERVER: 1   # Prevent Metro bundler connection attempts
          EXPO_TARGET: bare
        run: |
          cd example
          npm ci
          
          echo "üîç Checking for native changes (ios/, ios-files/, example/ios/, example/android/, app.json)..."

          # Detect if any native-related files changed
          if git diff --quiet HEAD^ HEAD -- \
              ../ios \
              ../ios-files \
              ios \
              android \
              app.json; then
            echo "‚úÖ No native changes detected ‚Äî skipping expo prebuild"
          else
            echo "‚öôÔ∏è Native changes detected ‚Äî running expo prebuild"
            npx expo prebuild --clean
          fi

          echo "üèóÔ∏è Building and installing the app (Release, no Metro)..."
          npx expo run:ios --configuration Release --no-bundler

      # If app was cached, just install it on simulator
      - name: Install cached app
        if: steps.app-cache.outputs.cache-hit == 'true'
        run: |
          echo "‚úÖ Using cached build ‚Äî installing app directly..."
          xcrun simctl install booted example/ios/build/Release-iphonesimulator/*.app

      # Cache built .app for next runs
      - name: Cache built app
        if: steps.app-cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: example/ios/build/Release-iphonesimulator
          key: ${{ runner.os }}-expo-app-${{ hashFiles('example/ios/Podfile.lock', 'ios/**', 'ios-files/**') }}

      # Run all Maestro E2E tests
      - name: Run all Maestro tests
        env:
          MAESTRO_APP_ID: com.swmansion.expoliveactivity.example
        run: |
          chmod +x example/tests/scripts/runAllTests.sh
          ./example/tests/scripts/runAllTests.sh

      # Upload Maestro debug artifacts (logs, screenshots)
      - name: Upload Maestro debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-debug
          path: ~/.maestro/tests/

      # Generate PDF report (always, even if tests fail)
      - name: Generate PDF report
        if: always()
        run: npm run generateTestReport

      # Upload the PDF report artifact
      - name: Upload PDF report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: live-activity-report
          path: example/tests/reports/live-activity-report.pdf
