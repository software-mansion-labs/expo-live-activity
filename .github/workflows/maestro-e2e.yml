name: E2E â€“ generate, run tests, build report

on:
  workflow_dispatch: {}
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  e2e:
    name: Run Maestro E2E on macOS
    runs-on: macos-15

    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up Node.js environment
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # Install project dependencies
      - name: Install dependencies
        run: npm ci

      # Generate Maestro test flows
      - name: Generate test flows
        env:
          MAESTRO_APP_ID: com.swmansion.expoliveactivity.example
        run: npm run generateTests

      # Set up Java (Zulu 17)
      - name: Set up Java (Zulu 17)
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      # Start an iOS simulator
      - name: Start iOS Simulator
        uses: futureware-tech/simulator-action@v2
        with:
          model: 'iPhone 16 Pro'

      # Install Maestro CLI using the official installer
      - name: Install Maestro CLI
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          export PATH="$PATH:$HOME/.maestro/bin"
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH
          maestro --version

      # Wait a few seconds to ensure the simulator is fully booted
      - name: Wait for iOS simulator to boot
        run: sleep 20

      # Install app on the simulator
      - name: Build and install example app
        env:
          EXPO_NO_DEV_SERVER: 1
        run: |
          cd example
          npm ci
          npx expo prebuild --clean
          npx expo run:ios --configuration Release --no-bundler

      # Run all Maestro E2E tests
      - name: Run all Maestro tests
        env:
          MAESTRO_APP_ID: com.swmansion.expoliveactivity.example
        run: |
          chmod +x example/tests/scripts/runAllTests.sh
          ./example/tests/scripts/runAllTests.sh

      # Upload Maestro debug artifacts
      - name: Upload Maestro debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-debug
          path: ~/.maestro/tests/

      # Generate a PDF test report
      - name: Generate PDF report
        run: npm run generateTestReport

      # Upload the PDF report as an artifact
      - name: Upload PDF report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: live-activity-report
          path: example/tests/reports/live-activity-report.pdf
